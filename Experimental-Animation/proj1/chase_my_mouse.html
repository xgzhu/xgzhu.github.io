<!DOCTYPE HTML>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
		<title>Chase My Mouse</title>
		<script type="text/javascript">
			var canvas = null;
			var context = null;
			var bufferCanvas = null;
			var bufferCanvasCtx = null;
			var animateTimer = null;
			var mousePos = null;
			var info = null;
			var debug = null;

			var mainMoth = {goalX: 0, goalY: 0, posX: 0, posY: 0, 
							velocity: 1.0, size: 200, series: 0, 
							orientation: 0, state: 0};
			var secondMoth = {goalX: 1450, goalY: 950, posX: 1450, posY: 950, 
							velocity: 1.0, size: 120, series: 0, 
							orientation: 0, state: 0};
			var imgArray = null;
			var bgImgArray = null;
			var rdImgArray = null;
			var torchImgArray = null;
			var torchIdx = 0;
			var torchSize = 100;
			var yellowLine = -1;
			var lightAudio = null;
			var carAudio = null;

			
			function init() {
				info = document.getElementById('info');
				debug = document.getElementById('debug');

				canvas = document.getElementById('shownCanvas');
				context = canvas.getContext("2d");
				// canvas.style.width = window.innerWidth + "px";
				// canvas.style.height = window.innerHeight + "px";
				
				bufferCanvas = document.createElement("canvas");
				bufferCanvasCtx = bufferCanvas.getContext("2d");
				bufferCanvasCtx.canvas.width = context.canvas.width;
				bufferCanvasCtx.canvas.height = context.canvas.height;

				buildFgImgArray();
				buildBgImgArray();
				buildRdImgArray();
				buildTorchImgArray();

				lightAudio = new Audio('sounds/fire_crackling_diegetic.mp3');
				lightAudio.loop = true;
				carAudio = new Audio('sounds/on_road.wav');
				carAudio.loop = true;

				canvas.addEventListener('mousemove', function(evt) {
					mousePos = getMousePos(canvas, evt);
					if (animateTimer == null) {
						mainMoth.posX = mousePos.x;
						mainMoth.posY = mousePos.y;
						animateTimer = setInterval(animate, 25);
					}
					mainMoth.state = 0;
					updateGoal(mainMoth);
				}, false);
  
			}

			function buildFgImgArray() {
				imgArray = [];
				for (i = 0; i <= 10; i++) {
					var img = document.createElement("img");
					if (i < 10)
						img.setAttribute("src", "moth_smoothflight/moth_smoothflight_0000"+i+".png");
					else 
						img.setAttribute("src", "moth_smoothflight/moth_smoothflight_000"+i+".png");
					imgArray.push(img);
				}
			}

			function buildBgImgArray() {
				bgImgArray = [];
				for (i = 147; i >= 0 ; i--) {
					var img = document.createElement("img");
					if (i < 10)
						img.setAttribute("src", "background/Lights_text2_0000"+i+".png");
					else if (i < 100)
						img.setAttribute("src", "background/Lights_text2_000"+i+".png");
					else 
						img.setAttribute("src", "background/Lights_text2_00"+i+".png");
					bgImgArray.push(img);
				}
			}
			function buildRdImgArray() {
				rdImgArray = [];
				for (i = 0; i <= 8; i++) {
					var img = document.createElement("img");
					img.setAttribute("src", "yellow_highway_lines/yellowhighway lines_0000"+i+".png");
					rdImgArray.push(img);
				}
			}
			function buildTorchImgArray() {
				torchImgArray = [];
				for (i = 0; i <= 399 ; i++) {
					var img = document.createElement("img");
					if (i < 10)
						img.setAttribute("src", "torch/torch_0000"+i+".png");
					else if (i < 100)
						img.setAttribute("src", "torch/torch_000"+i+".png");
					else 
						img.setAttribute("src", "torch/torch_00"+i+".png");
					torchImgArray.push(img);
				}
			}

			function getMousePos(canvas, evt) {
				var rect = canvas.getBoundingClientRect();
				return {
					x: evt.clientX - rect.left,
					y: evt.clientY - rect.top
				};
			}

			function blank(a) {
				bufferCanvasCtx.save();
				bufferCanvasCtx.globalAlpha = a; // [0, 392]


				var distance = mainMoth.posX * mainMoth.posX + (mainMoth.posY - 400) * (mainMoth.posY - 400) - 100;
				distance = Math.round(Math.sqrt(distance) / 3.3);
				if (distance >= 148) {
					distance = 147;
					lightAudio.pause();
				}
				else {
					if (lightAudio.currentTime > 10) lightAudio.currentTime = 2;
					lightAudio.volumn = (148 - distance) / 148.0
					lightAudio.play();
				}
				mainMoth.size = 200 + (148 - distance);

				// Draw background
				if (mainMoth.posX <= 500 || mainMoth.posX >= 800) {
					bufferCanvasCtx.drawImage(bgImgArray[distance], 0, 0, bufferCanvasCtx.canvas.width, bufferCanvasCtx.canvas.height);
				}

				// Yellow line
				if (mainMoth.posX > 500 && mainMoth.posX < 1000 && yellowLine == -1) {
					yellowLine = 0;
				}
				
				if (yellowLine >= 0) {
					bufferCanvasCtx.drawImage(rdImgArray[yellowLine], 0, 0, bufferCanvas.width, bufferCanvas.height);
					yellowLine += 1;
					carAudio.play();
				}
				else {
					carAudio.pause();
				}
				if (yellowLine > 8) {
					yellowLine = -1;
				}
				
				// Draw cursor curcle
				bufferCanvasCtx.restore();
				// bufferCanvasCtx.fillStyle = "#FFFF77";
				// bufferCanvasCtx.beginPath();
				// bufferCanvasCtx.arc(mousePos.x, mousePos.y, 5, 0, 2*Math.PI);
				// bufferCanvasCtx.fill();
				debug.innerHTML = torchIdx;
				bufferCanvasCtx.drawImage(torchImgArray[torchIdx], mousePos.x - torchSize / 2, mousePos.y - torchSize / 2, torchSize, torchSize);
				torchIdx += 1;
				if (torchIdx == 400) {
					torchIdx = 202;
				}

				bufferCanvasCtx.restore();
			}

			function animate() {
				// if (Update()) Draw();
				updateGoal(mainMoth);
				updateMove(mainMoth, 0.5, 16);
				blank(0.5);
				updateStoryLine();
				drawMove(mainMoth);
				context.drawImage(bufferCanvas, 0, 0, bufferCanvas.width, bufferCanvas.height);
				info.innerHTML= mainMoth.posX + ", " +  mainMoth.posY + "->" + mainMoth.goalX + ", " + mainMoth.goalY + " ---- " + secondMoth.posX + ", " +  secondMoth.posY + "->" + secondMoth.goalX + ", " + secondMoth.goalY + "(" + mainMoth.size;
				// info.innerHTML = lightAudio.currentTime + ", " + lightAudio.volumn;
			}

			function updateGoal(moth) {
				// offsetAngle -= offsetAngleInc;
				// moth.goalX = mousePos.x + offsetSpeed * Math.sin(offsetAngle);
				// moth.goalY = mousePos.y + offsetSpeed * Math.cos(offsetAngle);
				if (moth.state == 0) {
					moth.goalX = mousePos.x;
					moth.goalY = mousePos.y;
				}
				else if (moth.state == 100) {
					moth.state = 0;
					moth.goalX = mousePos.x + Math.random() * 300 - 150;
					moth.goalY = mousePos.y + Math.random() * 300 - 150;
				}
				moth.state++;
			}

			function updateMove(moth, stepin, maxspeed) {
				var numeratorX = abs(moth.posX - moth.goalX);
				var numeratorY = abs(moth.posY - moth.goalY);
				var dominator = numeratorX + numeratorY;
				
				if (moth.velocity < maxspeed) moth.velocity = moth.velocity + stepin;
				if (dominator < maxspeed * 20) moth.velocity = dominator / 20 - 1;

				moth.series += 1;
				if (moth.velocity > 8) moth.series += 1;
				if (moth.series >= imgArray.length) {
					moth.series -= imgArray.length;
				}

				if (dominator < maxspeed * 5) return;

				moth.velocity = Math.ceil(moth.velocity);

				var speedX = sign(moth.goalX - moth.posX) * min(moth.velocity * numeratorX / dominator, numeratorX);
				var speedY = sign(moth.goalY - moth.posY) * min(moth.velocity * numeratorY / dominator, numeratorY);
				moth.posX += Math.round(speedX);
				moth.posY += Math.round(speedY);

				moth.orientation = calculateAngle(speedX, speedY) + Math.PI/2;

			}

			function updateStoryLine() {
				// Second moth
				if (mainMoth.posX > 1000 && mainMoth.posY > 600) {
					if (secondMoth.state == 0) {
						secondMoth.goalX = mousePos.x;
						secondMoth.goalY = mousePos.y;
					}
					else if (secondMoth.state == 25){
						secondMoth.goalX = secondMoth.goalX + Math.random() * 100 - 50;
						secondMoth.goalY = secondMoth.goalY + Math.random() * 100 - 50;
						secondMoth.goalX = (secondMoth.goalX + mainMoth.goalX) / 2;
						secondMoth.goalY = (secondMoth.goalY + mainMoth.goalY) / 2;
						secondMoth.state = 0;
					}
					secondMoth.state += 1;
				}
				else {
					secondMoth.state = 0;
					secondMoth.goalX = 1450;
					secondMoth.goalY = 950;
				}
				updateMove(secondMoth, 0.3, 4);
				if (secondMoth.posX < 1450 && secondMoth.posY < 950)
					drawMove(secondMoth);
			}

			function drawMove(moth) {
				bufferCanvasCtx.save();

				bufferCanvasCtx.translate(moth.posX, moth.posY);
				bufferCanvasCtx.rotate(moth.orientation);
				bufferCanvasCtx.drawImage(imgArray[moth.series], - moth.size / 2, - moth.size / 2, moth.size, moth.size);

				bufferCanvasCtx.restore();
			}

			function calculateAngle(x, y) {
				var z = Math.sqrt(x * x + y * y);
				var ans = Math.acos(y/z);
				if (x > 0) ans = Math.PI * 2 - ans;
				return ans;
			}

			function abs(a) {
				if (a > 0) return a;
				return -a;
			}

			function sign(a) {
				if (a > 0) return 1;
				return -1;
			}

			function min(a, b) {
				if (a > b) return b;
				return a;
			}
		</script>
	</head>
	<body onload="init()">
		<canvas id="shownCanvas" width="1400" height="900" style="cursor: none;">
			Canvas not supported
		</canvas>
		<p id="info">info</p>
		<p id="debug">debug</p>

	</body>
</html>
