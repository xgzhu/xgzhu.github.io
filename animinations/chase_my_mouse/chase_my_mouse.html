<!DOCTYPE HTML>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
		<title>Chase My Mouse</title>
		<script type="text/javascript">
			var canvas = null;
			var context = null;
			var bufferCanvas = null;
			var bufferCanvasCtx = null;
			var animateTimer = null;
			var mousePos = null;
			var goalX = 0;
			var goalY = 0;
			var posX = 0;
			var posY = 0;
			var speed = 1.0;
			var info = null;
			var debug = null;
			var imgArray = null;
			var imgSize = 200;
			var imgNum = 0;
			var speedX = 0;
			var speedY = 0;
			var speedAngle = 0;
			var inertia = 0.3;
			// var offsetSpeed = 0;
			// var offsetAngle = 0;
			// var offsetAngleInc = 0.1;
			var state = 0;
			var audio = null;
			var storyPtr = -1;
			var storyLines = [];
			var storyTexts = [];
			
			function init() {
				info = document.getElementById('info');
				debug = document.getElementById('debug');

				canvas = document.getElementById('shownCanvas');
				context = canvas.getContext("2d");
				bufferCanvas = document.createElement("canvas");
				bufferCanvasCtx = bufferCanvas.getContext("2d");
				bufferCanvasCtx.canvas.width = context.canvas.width;
				bufferCanvasCtx.canvas.height = context.canvas.height;

				buildImgArray();
				buildStory();
				blank(1);
				context.drawImage(bufferCanvas, 0,0,bufferCanvas.width, bufferCanvas.height);
				audio = new Audio('about_dream.mp3');
				audio.loop = true;

				canvas.addEventListener('mousemove', function(evt) {
					mousePos = getMousePos(canvas, evt);
					if (animateTimer == null) {
						posX = mousePos.x;
						posY = mousePos.y;
						animateTimer = setInterval(animate, 25);
					}
					state = 0;
					updateGoal();
				}, false);
			}

			function buildImgArray() {
				imgArray = [];
				for (i = 0; i <= 96; i++) {
					var img = document.createElement("img");
					if (i < 10)
						img.setAttribute("src", "Jellyfish_loop/Jellyfish_loop_00000_0000"+i+".png");
					else
						img.setAttribute("src", "Jellyfish_loop/Jellyfish_loop_00000_000"+i+".png");
					img.setAttribute("width", imgSize);
					img.setAttribute("height", imgSize);
					imgArray.push(img);
				}
			}

			function buildStory() {
				storyLines.push([0, 80, 500, 200]);
				storyTexts.push("this is a story.")
				storyLines.push([bufferCanvasCtx.canvas.width, 280, bufferCanvasCtx.canvas.width - 500, 400]);
				storyTexts.push("this is a story, too.")
				storyLines.push([0, 480, 500, 600]);
				storyTexts.push("this is a story, three. :)")
			}

			function getMousePos(canvas, evt) {
				var rect = canvas.getBoundingClientRect();
				return {
					x: evt.clientX - rect.left,
					y: evt.clientY - rect.top
				};
			}

			function blank(a) {
				bufferCanvasCtx.fillStyle = "rgba(50, 70, 210, " + a + ")";
				bufferCanvasCtx.fillRect(0,0,bufferCanvasCtx.canvas.width, bufferCanvasCtx.canvas.height);
				for (i = 0; i < storyLines.length; i++) {
					bufferCanvasCtx.strokeStyle = "rgb(20, 210, 225)";
					bufferCanvasCtx.lineWidth=20;
					bufferCanvasCtx.beginPath();
					bufferCanvasCtx.moveTo(storyLines[i][0], storyLines[i][1]);
					bufferCanvasCtx.lineTo(storyLines[i][0], storyLines[i][3]);
					bufferCanvasCtx.stroke();
				}
				if (storyPtr == -1) return;
				bufferCanvasCtx.lineWidth=2;
				bufferCanvasCtx.textAlign = "center";
				bufferCanvasCtx.font = "50px Comic Sans MS";
				bufferCanvasCtx.strokeText(storyTexts[storyPtr], bufferCanvasCtx.canvas.width / 2 ,(storyLines[storyPtr][1] + storyLines[storyPtr][3]) / 2);
			}

			function animate() {
				// if (Update()) Draw();
				updateGoal();
				updateMove();
				updateStoryLine();
				drawMove();
				drawStoryLine();
				info.innerHTML= posX + ", " +  posY + "->" + goalX + ", " + goalY;
			}

			function updateGoal() {
				// offsetAngle -= offsetAngleInc;
				// goalX = mousePos.x + offsetSpeed * Math.sin(offsetAngle);
				// goalY = mousePos.y + offsetSpeed * Math.cos(offsetAngle);
				if (state == 0) {
					goalX = mousePos.x;
					goalY = mousePos.y;
				}
				else if (state == 100) {
					state = 0;
					goalX = mousePos.x + Math.random() * 200 - 100;
					goalY = mousePos.y + Math.random() * 200 - 100;
				}
				state++;
			}

			function updateMove() {
				var numeratorX = abs(posX - goalX);
				var numeratorY = abs(posY - goalY);
				var dominator = numeratorX + numeratorY;
				
				if (speed < 16) speed += 0.5;
				if (dominator < 300) speed = dominator / 20 - 1;
				// if (dominator < 50) return;

				speed = Math.round(speed);

				speedX = inertia * speedX + (1 - inertia) * sign(goalX - posX) * min(speed * numeratorX / dominator, numeratorX);
				speedY = inertia * speedY + (1 - inertia) * sign(goalY - posY) * min(speed * numeratorY / dominator, numeratorY);
				posX += Math.round(speedX);
				posY += Math.round(speedY);

				angle = calculateAngle(speedX, speedY);
				// speedAngle = inertia * speedAngle + (1 - inertia) * angle;
				// speedAngle = angle;
				speedAngle = angle + Math.PI;

				debug.innerHTML = "Go at speed (" + speedX +", " + speedY + "), with angle " + speedAngle;
			}

			function updateStoryLine() {
				var ptr = -1;
				for (i = 0; i < storyLines.length; i++) {
					if (((storyLines[i][0] < posX && storyLines[i][2] > posX) || (storyLines[i][0] > posX && storyLines[i][2] < posX)) && storyLines[i][1] < posY && storyLines[i][3] > posY) {
						ptr = i;
						break;
					}
				}
				if (storyPtr == ptr) {
					return;
				}
				if (ptr != -1) {
					audio.play();
				}
				else {
					audio.pause();
				}
				storyPtr = ptr;
			}

			function drawMove(){
				bufferCanvasCtx.save();
				blank(0.6);

				bufferCanvasCtx.translate(posX, posY);
				bufferCanvasCtx.rotate(speedAngle);
				bufferCanvasCtx.drawImage(imgArray[imgNum], - imgSize / 2, - imgSize / 2, imgSize, imgSize);

				imgNum += 1;
				if (imgNum >= imgArray.length) {
					imgNum = 0;
				}

				context.drawImage(bufferCanvas, 0,0,bufferCanvas.width, bufferCanvas.height);

				bufferCanvasCtx.restore();
			}

			function drawStoryLine() {
				if (storyPtr < 0) return;
				bufferCanvasCtx.save();
				bufferCanvasCtx.fillStyle = "rgba(255, 255, 10, 0.4)";
				bufferCanvasCtx.fillRect(0, storyLines[storyPtr][1], bufferCanvasCtx.canvas.width, storyLines[storyPtr][3] - storyLines[storyPtr][1]);
				context.drawImage(bufferCanvas, 0,0,bufferCanvas.width, bufferCanvas.height);
				bufferCanvasCtx.restore();
			}

			function calculateAngle(x, y) {
				var z = Math.sqrt(x * x + y * y);
				var ans = Math.acos(y/z);
				if (x > 0) ans = Math.PI * 2 - ans;
				return ans;
			}

			function abs(a) {
				if (a > 0) return a;
				return -a;
			}

			function sign(a) {
				if (a > 0) return 1;
				return -1;
			}

			function min(a, b) {
				if (a > b) return b;
				return a;
			}
		</script>
	</head>
	<body onload="init()">
		<canvas id="shownCanvas" width="1400" height="900">
			Canvas not supported
		</canvas>
		<p id="info">info</p>
		<p id="debug">debug</p>

	</body>
</html>
